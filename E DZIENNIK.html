<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e-Dziennik</title>
    <style>
        /* ... (Istniejący CSS - bez zmian z poprzedniej odpowiedzi, aby zaoszczędzić miejsce) ... */
        /* Drobne poprawki/dodatki jeśli potrzebne */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            transition: all 0.3s;
        }
        
        /* Strona logowania */
        .login-page {
            background: linear-gradient(135deg, #1e88e5, #0d47a1);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .login-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-logo {
            color: #1e88e5;
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .login-input, .admin-form select, .admin-form input, .teacher-form select, .teacher-form input, .form-common select, .form-common input, .form-common textarea  {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        .login-btn, .admin-form button, .teacher-form button, .form-common button {
            background: #1e88e5;
            color: white;
            border: none;
            padding: 12px;
            width: 100%;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 16px;
        }
        
        .login-btn:hover, .admin-form button:hover, .teacher-form button:hover, .form-common button:hover {
            background: #1565c0;
        }
        
        .error-msg {
            color: red;
            margin-top: 10px;
            min-height: 20px;
        }
        
        /* Panel główny */
        .main-page {
            display: none;
        }
        
        .header {
            background: linear-gradient(135deg, #1e88e5, #0d47a1);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: white;
            color: #1e88e5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .logout-btn {
            background: white;
            color: #1e88e5;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .container {
            display: flex;
            min-height: calc(100vh - 70px); /* Adjusted for header height */
        }
        
        /* Panel boczny */
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-menu li {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex; /* For icon alignment */
            align-items: center; /* For icon alignment */
            gap: 10px; /* Space between icon and text */
        }
        
        .sidebar-menu li:hover {
            background-color: #f0f7ff;
        }
        
        .sidebar-menu li.active {
            background-color: #e3f2fd;
            border-left: 4px solid #1e88e5;
            padding-left: 16px; /* Adjust for border */
        }

        .sidebar-menu li i {
            width: 20px; /* Ensure icons take up same space */
            text-align: center;
        }
        
        .user-details {
            padding: 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        
        .user-details .special-number {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* Główna zawartość */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .panel h2, .panel h3 {
            color: #0d47a1;
        }
        
        /* Karty funkcji */
        .function-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .function-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .function-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .function-card i {
            font-size: 36px;
            color: #1e88e5;
            margin-bottom: 10px;
        }
        
        /* Przycisk powrotu */
        .back-btn {
            background: #1e88e5;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .back-btn i {
            font-size: 14px;
        }
        
        /* Oceny */
        .grade {
            display: inline-block;
            width: 30px; /* Increased size */
            height: 30px; /* Increased size */
            line-height: 30px; /* Increased size */
            text-align: center;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            margin-right: 5px;
            margin-bottom: 5px; /* For wrapping */
            font-size: 14px; /* Adjusted font size */
        }
        
        .grade-6 { background-color: #2ecc71; } /* Celujący */
        .grade-5 { background-color: #4CAF50; } /* Bardzo dobry */
        .grade-4 { background-color: #8BC34A; } /* Dobry */
        .grade-3 { background-color: #FFC107; } /* Dostateczny */
        .grade-2 { background-color: #F44336; } /* Dopuszczający */
        .grade-1 { background-color: #795548; } /* Niedostateczny */
        .grade-P, .grade-p { background-color: #90caf9; } /* Plus */
        .grade-M, .grade-m { background-color: #ef9a9a; } /* Minus */

        /* Table styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #e3f2fd;
            color: #0d47a1;
        }
        .action-btn {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }
        .btn-edit { background-color: #ffc107; }
        .btn-delete { background-color: #f44336; }
        .btn-view { background-color: #1e88e5; }
        .btn-reply { background-color: #4caf50;}

        .form-common label, .admin-form label, .teacher-form label {
            display: block;
            margin-top: 10px;
            text-align: left;
            color: #333;
            font-weight: bold;
        }
        .message-item {
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .message-item:hover { background-color: #f9f9f9; }
        .message-item.unread { font-weight: bold; background-color: #e3f2fd; }

        .timetable table { border: 1px solid #ccc; }
        .timetable th, .timetable td { text-align: center; min-width: 80px; height: 40px; }
        .timetable th:first-child, .timetable td:first-child { background-color: #f0f0f0; font-weight: bold; } /* Godziny/Okresy */

        .tabs { margin-bottom: 15px; }
        .tabs button {
            padding: 10px 15px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            margin-right: 5px;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
        }
        .tabs button.active { background-color: white; border-bottom: 1px solid white; }
        hr { margin: 20px 0; border: 0; border-top: 1px solid #eee;}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="loginPage" class="login-page">
         <div class="login-box">
            <div class="login-logo">e-Dziennik</div>
            <input type="text" id="username" class="login-input" placeholder="Login" required>
            <input type="password" id="password" class="login-input" placeholder="Hasło" required>
            <button onclick="login()" class="login-btn">Zaloguj się</button>
            <div id="loginError" class="error-msg"></div>
        </div>
    </div>
    
    <div id="mainPage" class="main-page">
        <div class="header">
             <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <h2 id="welcomeText">e-Dziennik</h2>
            </div>
            <button class="logout-btn" onclick="logout()">Wyloguj</button>
        </div>
        
        <div class="container">
            <div class="sidebar">
                 <div class="user-details">
                    <div class="special-number" id="userSpecialNumber"></div>
                    <div>Jesteś zalogowany jako: <br><strong id="loggedUserName"></strong></div>
                    <div id="userRoleDisplay" style="font-size: 0.9em; color: #555; margin-top: 5px;"></div>
                </div>
                <ul class="sidebar-menu" id="sidebarMenu">
                    <li class="active" onclick="showMainView()"><i class="fas fa-home"></i> Strona główna</li>
                    <li onclick="showSection('grades')" data-role="student"><i class="fas fa-star"></i> Oceny</li>
                    <li onclick="showSection('attendance')" data-role="student teacher"><i class="fas fa-calendar-check"></i> Frekwencja</li>
                    <li onclick="showSection('timetable')" data-role="student teacher admin"><i class="fas fa-table-list"></i> Plan lekcji</li>
                    <li onclick="showSection('messages')" data-role="student teacher admin"><i class="fas fa-envelope"></i> Wiadomości (<span id="unreadMessagesCount">0</span>)</li>
                    <li onclick="showSection('announcements')" data-role="student teacher admin"><i class="fas fa-bullhorn"></i> Ogłoszenia</li>
                    <li onclick="showSection('calendar')" data-role="student teacher admin"><i class="fas fa-calendar-alt"></i> Terminarz</li>
                    
                    <li onclick="showSection('organization')" data-role="student teacher admin"><i class="fas fa-users"></i> Organizacja</li>
                    <li onclick="showSection('studentInfo')" data-role="student"><i class="fas fa-user-graduate"></i> Moje dane</li>
                    <li onclick="showSection('polls')" data-role="student teacher admin"><i class="fas fa-poll"></i> Ankiety</li>
                    <li onclick="showSection('books')" data-role="student teacher admin"><i class="fas fa-book"></i> Książki</li>
                    
                    <li onclick="showSection('teacherGradeManagement')" data-role="teacher"><i class="fas fa-edit"></i> Zarządzaj ocenami</li>
                    <li onclick="showSection('teacherAttendanceManagement')" data-role="teacher"><i class="fas fa-user-clock"></i> Zarządzaj frekwencją</li>
                    <li onclick="showSection('teacherStudentsView')" data-role="teacher"><i class="fas fa-chalkboard-teacher"></i> Moi uczniowie</li>

                    <li onclick="showSection('adminUserManagement')" data-role="admin"><i class="fas fa-users-cog"></i> Zarządzaj użytkownikami</li>
                    <li onclick="showSection('adminClassManagement')" data-role="admin"><i class="fas fa-school"></i> Zarządzaj klasami</li>
                    <li onclick="showSection('adminTimetableManagement')" data-role="admin"><i class="fas fa-edit"></i> Zarządzaj planem lekcji</li>

                    <li onclick="showSection('settings')" data-role="student teacher admin"><i class="fas fa-cog"></i> Ustawienia</li>
                    <li onclick="showSection('help')" data-role="student teacher admin"><i class="fas fa-question-circle"></i> Pomoc</li>
                </ul>
            </div>
            
            <div class="main-content">
                <div id="mainView" class="panel">
                    <h2>Witaj w e-Dzienniku!</h2>
                    <p>Wybierz jedną z opcji poniżej lub z menu bocznego, aby przejść do odpowiedniej sekcji:</p>
                    
                    <div class="function-cards">
                        <div class="function-card" onclick="showSection('grades')" data-role="student"> <i class="fas fa-star"></i><h3>Oceny</h3> </div>
                        <div class="function-card" onclick="showSection('timetable')" data-role="student teacher admin"> <i class="fas fa-table-list"></i><h3>Plan Lekcji</h3> </div>
                        <div class="function-card" onclick="showSection('attendance')" data-role="student teacher"> <i class="fas fa-calendar-check"></i><h3>Frekwencja</h3> </div>
                        <div class="function-card" onclick="showSection('messages')" data-role="student teacher admin"> <i class="fas fa-envelope"></i><h3>Wiadomości</h3> </div>
                        <div class="function-card" onclick="showSection('announcements')" data-role="student teacher admin"> <i class="fas fa-bullhorn"></i><h3>Ogłoszenia</h3> </div>
                        <div class="function-card" onclick="showSection('calendar')" data-role="student teacher admin"> <i class="fas fa-calendar-alt"></i><h3>Terminarz</h3> </div>
                        <div class="function-card" onclick="showSection('teacherGradeManagement')" data-role="teacher"> <i class="fas fa-edit"></i><h3>Zarządzaj Ocenami</h3> </div>
                        <div class="function-card" onclick="showSection('teacherAttendanceManagement')" data-role="teacher"> <i class="fas fa-user-clock"></i><h3>Zarządzaj Frekwencją</h3> </div>
                        <div class="function-card" onclick="showSection('adminUserManagement')" data-role="admin"> <i class="fas fa-users-cog"></i><h3>Zarządzaj Użytkownikami</h3> </div>
                        <div class="function-card" onclick="showSection('adminClassManagement')" data-role="admin"> <i class="fas fa-school"></i><h3>Zarządzaj Klasami</h3> </div>
                        <div class="function-card" onclick="showSection('adminTimetableManagement')" data-role="admin"> <i class="fas fa-edit"></i><h3>Zarządzaj Planem Lekcji</h3> </div>
                         <div class="function-card" onclick="showSection('settings')" data-role="student teacher admin"><i class="fas fa-cog"></i><h3>Ustawienia</h3></div>
                    </div>
                </div>
                
                <div id="gradesSection" class="panel" style="display: none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Twoje oceny</h2> <div id="studentGradesDetails"> <p>Ładowanie ocen...</p> </div> </div>
                <div id="studentInfoSection" class="panel" style="display: none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Dane ucznia</h2> <div id="studentDetailsContent">Ładowanie danych...</div> </div>
                <div id="organizationSection" class="panel" style="display: none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Organizacja</h2> <p>Informacje o strukturze szkoły, kontakty do sekretariatu, dyrekcji itp. (Treść statyczna)</p> </div>
                <div id="pollsSection" class="panel" style="display: none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Ankiety</h2> <p>W tym miejscu mogą pojawiać się ankiety szkolne do wypełnienia. (Funkcjonalność w budowie)</p> </div>
                <div id="booksSection" class="panel" style="display: none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Książki</h2> <p>Lista lektur, podręczników, materiałów dodatkowych. (Funkcjonalność w budowie)</p> </div>
                <div id="helpSection" class="panel" style="display: none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Pomoc</h2> <p>Instrukcje użytkowania e-Dziennika, FAQ, kontakt do pomocy technicznej. (Treść statyczna)</p> </div>

                <div id="teacherGradeManagementSection" class="panel teacher-form" style="display: none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Zarządzanie Ocenami</h2> <label for="teacherSubjectSelectGrade">Przedmiot:</label> <select id="teacherSubjectSelectGrade" onchange="renderTeacherGradeManagementTable()"></select> <label for="teacherStudentSelectGrade">Uczeń:</label> <select id="teacherStudentSelectGrade"></select> <label for="teacherGradeValueInput">Ocena:</label> <input type="text" id="teacherGradeValueInput" placeholder="np. 5, 4+, 3-"> <label for="teacherGradeDescriptionInput">Opis/Waga (opcjonalnie):</label> <input type="text" id="teacherGradeDescriptionInput" placeholder="np. Sprawdzian, Kartkówka (waga 3)"> <button onclick="addGradeByTeacher()">Dodaj Ocenę</button> <h3>Oceny wystawione (<span id="currentTeacherSubjectDisplay"></span>):</h3> <div id="teacherGradesTableContainer"></div> </div>
                <div id="teacherStudentsViewSection" class="panel" style="display: none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Moi Uczniowie</h2> <div id="teacherStudentsListContainer"></div> </div>

                <div id="adminUserManagementSection" class="panel admin-form" style="display: none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Zarządzanie Użytkownikami</h2> <h3>Dodaj nowego użytkownika</h3> <label for="adminAddUserLogin">Login:</label> <input type="text" id="adminAddUserLogin" placeholder="Login"> <label for="adminAddUserPassword">Hasło:</label> <input type="password" id="adminAddUserPassword" placeholder="Hasło"> <label for="adminAddUserName">Imię i Nazwisko:</label> <input type="text" id="adminAddUserName" placeholder="Imię i nazwisko"> <label for="adminAddUserRole">Rola:</label> <select id="adminAddUserRole" onchange="toggleAdminUserFields()"> <option value="student">Uczeń</option> <option value="teacher">Nauczyciel</option> <option value="admin">Administrator</option> </select> <div id="adminStudentFields" style="display: block;"> <label for="adminAddUserClass">Klasa (dla ucznia):</label> <select id="adminAddUserClass"></select> <label for="adminAddUserSpecialNumber">Szczęśliwy Numerek (dla ucznia):</label> <input type="text" id="adminAddUserSpecialNumber" placeholder="np. 12, hj"> </div> <div id="adminTeacherFields" style="display: none;"> <label for="adminAddUserSubjects">Przedmioty (dla nauczyciela, oddzielone przecinkami):</label> <input type="text" id="adminAddUserSubjects" placeholder="np. Matematyka, Fizyka"> <label for="adminAddUserTeacherClasses">Przypisane klasy (ID klas, oddzielone przecinkami):</label> <input type="text" id="adminAddUserTeacherClasses" placeholder="np. 1, 2"> </div> <button onclick="addUserByAdmin()">Dodaj użytkownika</button> <h3>Lista użytkowników</h3> <div id="adminUserListContainer"></div> </div>
                <div id="adminClassManagementSection" class="panel admin-form" style="display: none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Zarządzanie Klasami</h2> <h3>Dodaj nową klasę</h3> <label for="adminAddClassName">Nazwa klasy:</label> <input type="text" id="adminAddClassName" placeholder="np. 1A, 3C Technik Informatyk"> <label for="adminAddClassTeacher">Wychowawca (opcjonalnie, ID nauczyciela):</label> <select id="adminAddClassTeacher"></select> <button onclick="addClassByAdmin()">Dodaj klasę</button> <h3>Lista klas</h3> <div id="adminClassListContainer"></div> </div>

                <div id="attendanceSection" class="panel" style="display: none;">
                    <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button>
                    <h2>Frekwencja</h2>
                    <div id="studentAttendanceListContainer" data-role="student">Ładowanie frekwencji...</div>
                    <div data-role="teacher" style="display:none;"><p>Zarządzanie frekwencją przez nauczyciela - patrz osobna sekcja.</p></div>
                </div>

                <div id="teacherAttendanceManagementSection" class="panel teacher-form" style="display: none;">
                    <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button>
                   <h2>Zarządzanie Frekwencją</h2>
                   <label for="attTeacherClassSelect">Wybierz klasę:</label>
                   <select id="attTeacherClassSelect" onchange="renderTeacherAttendanceEditor()"></select>
                   <label for="attDateSelect">Data:</label>
                   <input type="date" id="attDateSelect" onchange="renderTeacherAttendanceEditor()">
                   <label for="attSubjectSelect">Przedmiot/Godzina lekcyjna:</label>
                   <select id="attSubjectSelect" onchange="renderTeacherAttendanceEditor()"></select> 
                   <div id="teacherAttendanceEditorContainer"></div>
                   <button onclick="saveTeacherAttendanceChanges()">Zapisz zmiany frekwencji</button>
               </div>

                <div id="timetableSection" class="panel timetable" style="display: none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Plan Lekcji</h2> <div id="timetableDisplayOptions" data-role="admin teacher"> <label for="timetableClassSelect">Wybierz klasę:</label> <select id="timetableClassSelect" onchange="renderTimetable()"></select> </div> <div id="timetableContainer"></div> </div>

                <div id="messagesSection" class="panel" style="display: none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Wiadomości</h2> <div class="tabs"> <button id="inboxTab" onclick="showMessagesTab('inbox')" class="active">Odebrane</button> <button id="sentTab" onclick="showMessagesTab('sent')">Wysłane</button> <button id="composeTab" onclick="showMessagesTab('compose')">Napisz wiadomość</button> </div> <div id="messagesInboxContainer"></div> <div id="messagesSentContainer" style="display: none;"></div> <div id="messagesComposeContainer" style="display: none;" class="form-common"> <label for="messageRecipient">Do:</label> <select id="messageRecipient"></select> <label for="messageTitle">Tytuł:</label> <input type="text" id="messageTitle" placeholder="Tytuł wiadomości"> <label for="messageContent">Treść:</label> <textarea id="messageContent" rows="5" placeholder="Wpisz treść wiadomości..."></textarea> <button onclick="sendMessage()">Wyślij</button> </div> <div id="messageViewContainer" style="display:none;" class="panel"> <button class="back-btn" onclick="hideMessageView()"><i class="fas fa-arrow-left"></i> Wróć do listy</button> <h3 id="viewMessageTitle"></h3> <p><small>Od: <span id="viewMessageSender"></span></small><br> <small>Do: <span id="viewMessageRecipient"></span></small><br> <small>Data: <span id="viewMessageDate"></span></small></p> <div id="viewMessageContent"></div> <button id="replyMessageBtn" class="action-btn btn-reply" onclick="replyToMessage()">Odpowiedz</button> </div> </div>

                <div id="announcementsSection" class="panel" style="display: none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Ogłoszenia</h2> <div id="addAnnouncementFormContainer" data-role="admin teacher" class="form-common" style="display:none; margin-bottom:20px;"> <h3>Dodaj nowe ogłoszenie</h3> <label for="announcementTitle">Tytuł:</label> <input type="text" id="announcementTitle" placeholder="Tytuł ogłoszenia"> <label for="announcementContent">Treść:</label> <textarea id="announcementContent" rows="4" placeholder="Treść ogłoszenia"></textarea> <label for="announcementAudience">Dla kogo:</label> <select id="announcementAudience"> <option value="all">Wszyscy</option> <option value="all_students">Wszyscy uczniowie</option> <option value="all_teachers">Wszyscy nauczyciele</option> </select> <button onclick="addAnnouncement()">Dodaj Ogłoszenie</button> </div> <button id="toggleAddAnnouncementBtn" data-role="admin teacher" onclick="toggleAddAnnouncementForm()" class="login-btn" style="width:auto; margin-bottom:15px;">Dodaj Ogłoszenie</button> <div id="announcementsListContainer"></div> </div>

                <div id="calendarSection" class="panel" style="display: none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Terminarz</h2> <div id="addCalendarEventFormContainer" data-role="admin teacher" class="form-common" style="display:none; margin-bottom:20px;"> <h3>Dodaj nowe wydarzenie</h3> <label for="calendarEventTitle">Tytuł:</label> <input type="text" id="calendarEventTitle" placeholder="Tytuł wydarzenia"> <label for="calendarEventDate">Data:</label> <input type="date" id="calendarEventDate"> <label for="calendarEventDescription">Opis:</label> <textarea id="calendarEventDescription" rows="3" placeholder="Opis wydarzenia"></textarea> <label for="calendarEventAudience">Dla kogo:</label> <select id="calendarEventAudience"> <option value="all">Wszyscy</option> <option value="all_students">Wszyscy uczniowie</option> <option value="all_teachers">Wszyscy nauczyciele</option> </select> <button onclick="addCalendarEvent()">Dodaj Wydarzenie</button> </div> <button id="toggleAddCalendarEventBtn" data-role="admin teacher" onclick="toggleAddCalendarEventForm()" class="login-btn" style="width:auto; margin-bottom:15px;">Dodaj Wydarzenie</button> <div id="calendarEventsListContainer"></div> </div>
                
                <div id="adminTimetableManagementSection" class="panel admin-form" style="display:none;"> <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button> <h2>Zarządzanie Planem Lekcji</h2> <label for="adminTimetableClassSelect">Wybierz klasę do edycji:</label> <select id="adminTimetableClassSelect" onchange="renderAdminTimetableEditor()"></select> <h3>Dodaj/Edytuj pozycję w planie</h3> <input type="hidden" id="adminTimetableEntryId"> <label for="adminTimetableDay">Dzień tygodnia:</label> <select id="adminTimetableDay"> <option value="1">Poniedziałek</option> <option value="2">Wtorek</option> <option value="3">Środa</option> <option value="4">Czwartek</option> <option value="5">Piątek</option> </select> <label for="adminTimetablePeriod">Okres (np. 1, 2, 8:00-8:45):</label> <input type="text" id="adminTimetablePeriod" placeholder="np. 1 lub 8:00-8:45"> <label for="adminTimetableSubject">Przedmiot:</label> <input type="text" id="adminTimetableSubject" placeholder="Nazwa przedmiotu"> <label for="adminTimetableTeacher">Nauczyciel:</label> <select id="adminTimetableTeacherSelect"></select> <label for="adminTimetableRoom">Sala:</label> <input type="text" id="adminTimetableRoom" placeholder="Numer sali"> <button onclick="saveTimetableEntryByAdmin()">Zapisz Pozycję</button> <button onclick="clearAdminTimetableForm()" style="background-color:#aaa; margin-top:5px;">Wyczyść Formularz</button> <h3>Aktualny plan dla wybranej klasy:</h3> <div id="adminTimetablePreviewContainer" class="timetable"></div> </div>
                
                <div id="settingsSection" class="panel form-common" style="display: none;">
                    <button class="back-btn" onclick="showMainView()"><i class="fas fa-arrow-left"></i> Powrót</button>
                    <h2>Ustawienia Konta</h2>
                    <h3>Zmień wyświetlaną nazwę</h3>
                    <label for="settingCurrentName">Aktualna nazwa:</label>
                    <input type="text" id="settingCurrentName" readonly style="background-color: #eee;">
                    <label for="settingNewName">Nowa nazwa:</label>
                    <input type="text" id="settingNewName" placeholder="Wpisz nową nazwę">
                    <button onclick="updateUserDisplayName()">Zapisz nową nazwę</button>
                    <hr>
                    <h3>Zmiana Hasła</h3>
                    <p>Zmiana hasła w tej wersji demonstracyjnej nie jest w pełni bezpieczna i nie została zaimplementowana. W pełnej wersji systemu ta opcja wymagałaby dodatkowych zabezpieczeń po stronie serwera.</p>
                    <hr>
                    <h3>Motyw (Symulacja)</h3>
                    <button onclick="alert('Zmiana motywu - funkcjonalność w budowie!')">Zmień na ciemny (Symulacja)</button>
                </div>

            </div>
        </div>
    </div>
    
    <script>
    // --- DATA STORE (Simulated Database using localStorage) ---
    let loggedInUser = null;

    // Default data - will be overridden by localStorage if available
    let initialUsers = [ /* ... bez zmian ... */ 
        { id: 1, login: "admin", password: "admin123", name: "Administrator Adminowski", role: "admin" },
        { id: 2, login: "nauczyciel", password: "nauczyciel123", name: "Jan Nauczycielski", role: "teacher", subjects: ["Matematyka", "Informatyka"], classIds: [101, 102] },
        { id: 3, login: "nauczyciel2", password: "nauczyciel123", name: "Anna Pedagog", role: "teacher", subjects: ["Język Polski", "Historia"], classIds: [101] },
        { id: 10, login: "uczen", password: "uczen123", name: "Gabriel Jezioł", role: "student", classId: 101, specialNumber: "hj" },
        { id: 11, login: "uczen2", password: "uczen123", name: "Anna Kowalska", role: "student", classId: 101, specialNumber: "7" },
        { id: 12, login: "uczen3", password: "uczen123", name: "Piotr Nowak", role: "student", classId: 102, specialNumber: "15" }
    ];
    let initialClasses = [ /* ... bez zmian ... */ 
        { id: 101, name: "Klasa 1A TI", teacherId: 2 }, 
        { id: 102, name: "Klasa 2B LO", teacherId: null }
    ];
    let initialGrades = [ /* ... bez zmian ... */ 
        { id: 1, studentId: 10, subject: "Matematyka", value: "5", description: "Sprawdzian", date: "2025-05-10", teacherId: 2},
        { id: 2, studentId: 10, subject: "Matematyka", value: "4", description: "Kartkówka", date: "2025-05-15", teacherId: 2},
        { id: 3, studentId: 10, subject: "Informatyka", value: "5+", description: "Projekt", date: "2025-05-20", teacherId: 2},
        { id: 4, studentId: 11, subject: "Matematyka", value: "3", description: "Odpowiedź", date: "2025-05-12", teacherId: 2},
        { id: 5, studentId: 10, subject: "Język Polski", value: "4-", description: "Wypracowanie", date: "2025-05-18", teacherId: 3},
    ];
    let initialAttendance = [ // Dodano przykładowe dane
        {id: 1, studentId: 10, date: "2025-05-27", subject: "Matematyka", status: "obecny", teacherId: 2},
        {id: 2, studentId: 10, date: "2025-05-28", subject: "Język Polski", status: "spóźniony", teacherId: 3},
        {id: 3, studentId: 10, date: "2025-05-29", subject: "Informatyka", status: "nieobecny (uspraw.)", teacherId: 2},
        {id: 4, studentId: 11, date: "2025-05-27", subject: "Matematyka", status: "nieobecny", teacherId: 2},
    ]; 
    let initialAnnouncements = [ /* ... bez zmian ... */ 
        {id: 1, title: "Zebranie z rodzicami", content: "Zapraszamy na zebranie z rodzicami dnia 15.06.2025 o godzinie 17:00.", date: "2025-05-25", authorId: 1, authorName: "Administrator Adminowski", audience: "all"}
    ];
    let initialTimetables = [ /* ... bez zmian ... */ 
        {id:1, classId: 101, dayOfWeek: 1, period: "1 (8:00-8:45)", subject: "Matematyka", teacherId: 2, room: "101"},
        {id:2, classId: 101, dayOfWeek: 1, period: "2 (8:55-9:40)", subject: "Język Polski", teacherId: 3, room: "203"},
        {id:3, classId: 101, dayOfWeek: 2, period: "1 (8:00-8:45)", subject: "Informatyka", teacherId: 2, room: "LAB1"},
        {id:4, classId: 102, dayOfWeek: 1, period: "1 (8:00-8:45)", subject: "Fizyka", teacherId: null, room: "305"},
    ];
    let initialCalendarEvents = [ /* ... bez zmian ... */ 
        {id: 1, title: "Wycieczka do Muzeum", date: "2025-06-10", description: "Wycieczka klasowa dla 1A TI do Muzeum Narodowego.", createdByUserId: 2, audience: "class_101"},
        {id: 2, title: "Dzień Sportu", date: "2025-06-20", description: "Ogólnoszkolny Dzień Sportu. Obecność obowiązkowa.", createdByUserId: 1, audience: "all_students"}
    ];
    let initialMessages = [ /* ... bez zmian ... */ 
        {id: 1, senderId: 2, recipientId: 10, title: "Poprawa sprawdzianu", content: "Gabrielu, proszę o kontakt w sprawie możliwości poprawy ostatniego sprawdzianu z matematyki.", date: "2025-05-20T10:00:00Z", read: false},
        {id: 2, senderId: 1, recipientId: 2, title: "Spotkanie Rady Pedagogicznej", content: "Zapraszam na spotkanie Rady Pedagogicznej w najbliższy piątek o 15:00.", date: "2025-05-22T14:00:00Z", read: true}
    ];

    let users = [];
    let classes = [];
    let grades = [];
    let attendance = [];
    let announcements = [];
    let timetables = [];
    let calendarEvents = [];
    let messages = [];

    function loadData() { /* ... bez zmian ... */ 
        users = JSON.parse(localStorage.getItem('eDziennik_users')) || JSON.parse(JSON.stringify(initialUsers));
        classes = JSON.parse(localStorage.getItem('eDziennik_classes')) || JSON.parse(JSON.stringify(initialClasses));
        grades = JSON.parse(localStorage.getItem('eDziennik_grades')) || JSON.parse(JSON.stringify(initialGrades));
        attendance = JSON.parse(localStorage.getItem('eDziennik_attendance')) || JSON.parse(JSON.stringify(initialAttendance));
        announcements = JSON.parse(localStorage.getItem('eDziennik_announcements')) || JSON.parse(JSON.stringify(initialAnnouncements));
        timetables = JSON.parse(localStorage.getItem('eDziennik_timetables')) || JSON.parse(JSON.stringify(initialTimetables));
        calendarEvents = JSON.parse(localStorage.getItem('eDziennik_calendarEvents')) || JSON.parse(JSON.stringify(initialCalendarEvents));
        messages = JSON.parse(localStorage.getItem('eDziennik_messages')) || JSON.parse(JSON.stringify(initialMessages));
        
        if (!localStorage.getItem('eDziennik_users')) saveData();
    }
    function saveData() { /* ... bez zmian ... */ 
        localStorage.setItem('eDziennik_users', JSON.stringify(users));
        localStorage.setItem('eDziennik_classes', JSON.stringify(classes));
        localStorage.setItem('eDziennik_grades', JSON.stringify(grades));
        localStorage.setItem('eDziennik_attendance', JSON.stringify(attendance));
        localStorage.setItem('eDziennik_announcements', JSON.stringify(announcements));
        localStorage.setItem('eDziennik_timetables', JSON.stringify(timetables));
        localStorage.setItem('eDziennik_calendarEvents', JSON.stringify(calendarEvents));
        localStorage.setItem('eDziennik_messages', JSON.stringify(messages));
    }
    function getNextId(array) { /* ... bez zmian ... */ 
        return array.length > 0 ? Math.max(...array.map(item => item.id || 0)) + 1 : 1;
    }
    
    function checkAuth() { /* ... bez zmian ... */ 
        const userString = localStorage.getItem('eDziennik_loggedInUser');
        if (userString) {
            loggedInUser = JSON.parse(userString);
            showMainPage(loggedInUser);
        } else {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainPage').style.display = 'none';
        }
    }
    function login() { /* ... bez zmian ... */ 
        const usernameInput = document.getElementById('username').value.trim();
        const passwordInput = document.getElementById('password').value.trim();
        const errorElement = document.getElementById('loginError');
        errorElement.textContent = "";
        if (!usernameInput || !passwordInput) { errorElement.textContent = "Wprowadź login i hasło!"; return; }
        const foundUser = users.find(u => u.login === usernameInput && u.password === passwordInput);
        if (foundUser) {
            loggedInUser = foundUser;
            localStorage.setItem('eDziennik_loggedInUser', JSON.stringify(loggedInUser));
            showMainPage(loggedInUser);
        } else { errorElement.textContent = "Błędny login lub hasło!"; }
    }
    function logout() { /* ... bez zmian ... */ 
        localStorage.removeItem('eDziennik_loggedInUser');
        loggedInUser = null;
        document.getElementById('mainPage').style.display = 'none';
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('loginError').textContent = '';
    }
    function showMainPage(user) { /* ... Zaktualizowano, aby pokazać liczbę nieprzeczytanych wiadomości ... */
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainPage').style.display = 'block';
        document.getElementById('welcomeText').textContent = `Witaj, ${user.name}!`;
        document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
        document.getElementById('loggedUserName').textContent = user.name;
        document.getElementById('userSpecialNumber').textContent = user.role === 'student' ? `Szczęśliwy numerek: ${user.specialNumber || 'brak'}` : '';
        let roleName = "";
        if (user.role === 'admin') roleName = "Administrator";
        else if (user.role === 'teacher') roleName = "Nauczyciel";
        else if (user.role === 'student') roleName = "Uczeń";
        document.getElementById('userRoleDisplay').textContent = `Rola: ${roleName}`;

        updateSidebarForRole(user.role);
        updateFunctionCardsForRole(user.role);
        updateUnreadMessagesCount(); // Dodano
        showMainView(); 
    }
    function updateSidebarForRole(role) { /* ... bez zmian ... */ 
        const menuItems = document.querySelectorAll('#sidebarMenu li');
        menuItems.forEach(item => {
            const roles = item.dataset.role;
            if (roles && !roles.split(' ').includes(role)) { item.style.display = 'none'; } 
            else { item.style.display = 'flex'; }
        });
        document.querySelectorAll('[id^="toggleAdd"][data-role], [data-role-form]').forEach(el => { // Dodano [data-role-form]
            const roles = el.dataset.role || el.dataset.roleForm;
             if (roles && !roles.split(' ').includes(role)) { el.style.display = 'none'; } 
             else { el.style.display = el.tagName === 'BUTTON' ? 'inline-block' : 'block';}
        });
    }
    function updateFunctionCardsForRole(role) { /* ... bez zmian ... */ 
        const cards = document.querySelectorAll('#mainView .function-card');
        cards.forEach(card => {
            const cardRoles = card.dataset.role;
             if (cardRoles && !cardRoles.split(' ').includes(role)) { card.style.display = 'none'; } 
             else { card.style.display = 'block';  }
        });
    }
    function showMainView() { /* ... bez zmian ... */ 
        hideAllSections();
        document.getElementById('mainView').style.display = 'block';
        setActiveMenuItem(document.querySelector('.sidebar-menu li[onclick="showMainView()"]'));
    }
    function showSection(sectionId) { // Zaktualizowano o nowe sekcje
        hideAllSections();
        const sectionElement = document.getElementById(sectionId + 'Section');
        if (sectionElement) {
            sectionElement.style.display = 'block';
            if (sectionId === 'grades' && loggedInUser.role === 'student') renderStudentGrades();
            if (sectionId === 'attendance') { // Obsługa frekwencji dla ucznia i nauczyciela
                 if (loggedInUser.role === 'student') renderStudentAttendance();
                 // Dla nauczyciela główny widok frekwencji może być informacyjny, a zarządzanie w teacherAttendanceManagementSection
            }
            if (sectionId === 'studentInfo' && loggedInUser.role === 'student') renderStudentInfo();
            if (sectionId === 'adminUserManagement' && loggedInUser.role === 'admin') renderAdminUserManagement();
            if (sectionId === 'adminClassManagement' && loggedInUser.role === 'admin') renderAdminClassManagement();
            if (sectionId === 'teacherGradeManagement' && loggedInUser.role === 'teacher') renderTeacherGradeManagement();
            if (sectionId === 'teacherAttendanceManagement' && loggedInUser.role === 'teacher') renderTeacherAttendanceManagement();
            if (sectionId === 'teacherStudentsView' && loggedInUser.role === 'teacher') renderTeacherStudentsView();
            if (sectionId === 'timetable') renderTimetable();
            if (sectionId === 'messages') renderMessages(); 
            if (sectionId === 'announcements') renderAnnouncements();
            if (sectionId === 'calendar') renderCalendarEvents();
            if (sectionId === 'adminTimetableManagement' && loggedInUser.role === 'admin') renderAdminTimetableManagement();
            if (sectionId === 'settings') renderSettings(); // Dodano

            const menuItem = document.querySelector(`.sidebar-menu li[onclick="showSection('${sectionId}')"]`);
            setActiveMenuItem(menuItem);
        } else {
            console.error("Section not found: " + sectionId + "Section");
            showMainView(); 
        }
    }
    function hideAllSections() { /* ... bez zmian ... */ 
        document.querySelectorAll('.main-content .panel').forEach(panel => { panel.style.display = 'none'; });
        if(document.getElementById('messageViewContainer')) document.getElementById('messageViewContainer').style.display = 'none';
    }
    function setActiveMenuItem(activeItem) { /* ... bez zmian ... */ 
        document.querySelectorAll('.sidebar-menu li').forEach(item => { item.classList.remove('active'); });
        if (activeItem) { activeItem.classList.add('active'); }
    }
    
    function renderStudentGrades() { /* ... bez zmian ... */ 
        const gradesDetailsContainer = document.getElementById('studentGradesDetails');
        if (!loggedInUser || loggedInUser.role !== 'student') { gradesDetailsContainer.innerHTML = "<p>Brak dostępu do ocen.</p>"; return; }
        const studentGrades = grades.filter(g => g.studentId === loggedInUser.id);
        if (studentGrades.length === 0) { gradesDetailsContainer.innerHTML = "<p>Nie masz jeszcze żadnych ocen.</p>"; return; }
        let html = ''; const subjects = [...new Set(studentGrades.map(g => g.subject))];
        subjects.forEach(subject => {
            const gradesForSubject = studentGrades.filter(g => g.subject === subject);
            const teacher = users.find(u => u.id === gradesForSubject[0]?.teacherId);
            html += `<div class="panel"><h3>${subject}</h3>`;
            if (teacher) html += `<p>Nauczyciel: ${teacher.name}</p>`;
            html += `<p>Oceny: `;
            gradesForSubject.forEach(grade => {
                let gradeClassVal = grade.value.replace(/[+-]/g, ''); let gradeClass = `grade-${gradeClassVal}`;
                if (!/^[1-6]$/.test(gradeClassVal)) gradeClass = `grade-${grade.value.toUpperCase()}`;
                html += `<span class="grade ${gradeClass}" title="${grade.description || 'Ocena'} (${grade.date})">${grade.value}</span>`;
            }); html += `</p>`;
            const numericGrades = gradesForSubject.map(g => parseFloat(g.value)).filter(v => !isNaN(v));
            if (numericGrades.length > 0) { const average = numericGrades.reduce((sum, val) => sum + val, 0) / numericGrades.length; html += `<p>Średnia z przedmiotu: ${average.toFixed(2)}</p>`; }
            html += `</div>`;
        });
        const allNumericGrades = studentGrades.map(g => parseFloat(g.value)).filter(v => !isNaN(v));
        if(allNumericGrades.length > 0) { const overallAverage = allNumericGrades.reduce((sum, val) => sum + val, 0) / allNumericGrades.length; html += `<div class="panel"><h3>Podsumowanie</h3><p>Średnia ogólna (uproszczona): ${overallAverage.toFixed(2)}</p><p>Liczba wszystkich ocen: ${studentGrades.length}</p></div>`;}
        gradesDetailsContainer.innerHTML = html;
    }
    function renderStudentInfo() { /* ... bez zmian ... */  
        const container = document.getElementById('studentDetailsContent');
         if (!loggedInUser || loggedInUser.role !== 'student') { container.innerHTML = "<p>Brak dostępu.</p>"; return; }
        const studentClass = classes.find(c => c.id === loggedInUser.classId);
        let html = `<h3>${loggedInUser.name}</h3><p><strong>Login:</strong> ${loggedInUser.login}</p><p><strong>Rola:</strong> Uczeń</p><p><strong>Klasa:</strong> ${studentClass ? studentClass.name : 'Nieprzypisany'}</p><p><strong>Szczęśliwy numerek:</strong> ${loggedInUser.specialNumber || 'Brak'}</p>`;
        container.innerHTML = html;
    }
    function toggleAdminUserFields() { /* ... bez zmian ... */ 
        const role = document.getElementById('adminAddUserRole').value;
        document.getElementById('adminStudentFields').style.display = role === 'student' ? 'block' : 'none';
        document.getElementById('adminTeacherFields').style.display = role === 'teacher' ? 'block' : 'none';
    }
    function renderAdminUserManagement() { /* ... bez zmian ... */  
        const classSelect = document.getElementById('adminAddUserClass');
        classSelect.innerHTML = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        if (classes.length === 0) classSelect.innerHTML = `<option value="">Brak klas do wyboru</option>`;
        toggleAdminUserFields(); 
        const userListContainer = document.getElementById('adminUserListContainer');
        let tableHtml = `<table><thead><tr><th>ID</th><th>Login</th><th>Nazwa</th><th>Rola</th><th>Klasa/Przedmioty</th><th>Akcje</th></tr></thead><tbody>`;
        users.forEach(user => {
            let roleSpecificInfo = '';
            if (user.role === 'student') { const studentClass = classes.find(c => c.id === user.classId); roleSpecificInfo = studentClass ? studentClass.name : 'Brak klasy'; } 
            else if (user.role === 'teacher') { roleSpecificInfo = user.subjects ? user.subjects.join(', ') : 'Brak przedmiotów';}
            tableHtml += `<tr><td>${user.id}</td><td>${user.login}</td><td>${user.name}</td><td>${user.role}</td><td>${roleSpecificInfo}</td><td><button class="action-btn btn-delete" onclick="deleteUserByAdmin(${user.id})">Usuń</button></td></tr>`;
        }); tableHtml += `</tbody></table>`; userListContainer.innerHTML = tableHtml;
    }
    function addUserByAdmin() { /* ... bez zmian ... */  
        const login = document.getElementById('adminAddUserLogin').value.trim(); const password = document.getElementById('adminAddUserPassword').value;  const name = document.getElementById('adminAddUserName').value.trim(); const role = document.getElementById('adminAddUserRole').value;
        if (!login || !password || !name) { alert("Login, hasło i nazwa są wymagane!"); return; }
        if (users.find(u => u.login === login)) { alert("Użytkownik o takim loginie już istnieje!"); return; }
        const newUser = { id: getNextId(users), login, password, name, role };
        if (role === 'student') { const classId = document.getElementById('adminAddUserClass').value; const specialNumber = document.getElementById('adminAddUserSpecialNumber').value.trim(); if (classId) newUser.classId = parseInt(classId); if (specialNumber) newUser.specialNumber = specialNumber; } 
        else if (role === 'teacher') { const subjectsStr = document.getElementById('adminAddUserSubjects').value.trim(); const classIdsStr = document.getElementById('adminAddUserTeacherClasses').value.trim(); if (subjectsStr) newUser.subjects = subjectsStr.split(',').map(s => s.trim()).filter(s => s); if (classIdsStr) newUser.classIds = classIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));}
        users.push(newUser); saveData(); renderAdminUserManagement(); alert("Użytkownik dodany!");
        document.getElementById('adminAddUserLogin').value = ''; document.getElementById('adminAddUserPassword').value = ''; document.getElementById('adminAddUserName').value = ''; document.getElementById('adminAddUserSpecialNumber').value = ''; document.getElementById('adminAddUserSubjects').value = ''; document.getElementById('adminAddUserTeacherClasses').value = '';
    }
    function deleteUserByAdmin(userId) { /* ... bez zmian, ale dodano czyszczenie frekwencji ... */  
        if (confirm(`Czy na pewno chcesz usunąć użytkownika o ID: ${userId}? Tej operacji nie można cofnąć.`)) {
            if (loggedInUser && loggedInUser.id === userId) { alert("Nie możesz usunąć samego siebie!"); return; }
            users = users.filter(user => user.id !== userId);
            grades = grades.filter(grade => grade.studentId !== userId && grade.teacherId !== userId);
            messages = messages.filter(msg => msg.senderId !== userId && msg.recipientId !== userId);
            calendarEvents = calendarEvents.filter(event => event.createdByUserId !== userId);
            attendance = attendance.filter(att => att.studentId !== userId && att.teacherId !== userId); // Dodano
            timetables.forEach(entry => { if(entry.teacherId === userId) entry.teacherId = null; });
            saveData(); renderAdminUserManagement(); alert("Użytkownik usunięty.");
        }
    }
    function renderAdminClassManagement() { /* ... bez zmian ... */  
        const teacherSelect = document.getElementById('adminAddClassTeacher');
        teacherSelect.innerHTML = '<option value="">Brak (bez wychowawcy)</option>' +  users.filter(u => u.role === 'teacher').map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        const classListContainer = document.getElementById('adminClassListContainer');
        let tableHtml = `<table><thead><tr><th>ID</th><th>Nazwa Klasy</th><th>Wychowawca</th><th>Akcje</th></tr></thead><tbody>`;
        classes.forEach(cls => { const teacher = users.find(u => u.id === cls.teacherId && u.role === 'teacher'); tableHtml += `<tr><td>${cls.id}</td><td>${cls.name}</td><td>${teacher ? teacher.name : 'Brak'}</td><td><button class="action-btn btn-delete" onclick="deleteClassByAdmin(${cls.id})">Usuń</button></td></tr>`; });
        tableHtml += `</tbody></table>`; classListContainer.innerHTML = tableHtml;
    }
    function addClassByAdmin() { /* ... bez zmian ... */  
        const name = document.getElementById('adminAddClassName').value.trim(); const teacherId = document.getElementById('adminAddClassTeacher').value;
        if (!name) { alert("Nazwa klasy jest wymagana!"); return; }
        if (classes.find(c => c.name.toLowerCase() === name.toLowerCase())) { alert("Klasa o takiej nazwie już istnieje!"); return; }
        const newClass = { id: getNextId(classes), name: name, teacherId: teacherId ? parseInt(teacherId) : null };
        classes.push(newClass); saveData(); renderAdminClassManagement(); renderAdminUserManagement(); alert("Klasa dodana!");
        document.getElementById('adminAddClassName').value = '';
    }
    function deleteClassByAdmin(classId) { /* ... bez zmian ... */  
         if (confirm(`Czy na pewno chcesz usunąć klasę o ID: ${classId}? Spowoduje to również odpięcie uczniów od tej klasy.`)) {
            classes = classes.filter(cls => cls.id !== classId);
            users.forEach(user => { if (user.role === 'student' && user.classId === classId) user.classId = null; });
            timetables = timetables.filter(entry => entry.classId !== classId);
            saveData(); renderAdminClassManagement(); renderAdminUserManagement(); alert("Klasa usunięta.");
        }
    }
    function renderTeacherGradeManagement() { /* ... bez zmian ... */  
        if (!loggedInUser || loggedInUser.role !== 'teacher' || !loggedInUser.subjects) { document.getElementById('teacherGradeManagementSection').innerHTML = "<p>Brak dostępu lub nie przypisano przedmiotów.</p>"; return; }
        const subjectSelect = document.getElementById('teacherSubjectSelectGrade'); subjectSelect.innerHTML = loggedInUser.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
        const studentSelect = document.getElementById('teacherStudentSelectGrade'); let studentsInTeacherClasses = [];
        if (loggedInUser.classIds && loggedInUser.classIds.length > 0) { loggedInUser.classIds.forEach(classId => { const studentsInClass = users.filter(u => u.role === 'student' && u.classId === classId); studentsInTeacherClasses.push(...studentsInClass); });}
        studentSelect.innerHTML = studentsInTeacherClasses.map(s => `<option value="${s.id}">${s.name} (Klasa: ${classes.find(c=>c.id === s.classId)?.name || 'N/A'})</option>`).join('');
        if (studentsInTeacherClasses.length === 0) studentSelect.innerHTML = `<option value="">Brak uczniów w przypisanych klasach</option>`;
        renderTeacherGradeManagementTable();
    }
    function renderTeacherGradeManagementTable() { /* ... bez zmian ... */  
        const selectedSubject = document.getElementById('teacherSubjectSelectGrade').value; document.getElementById('currentTeacherSubjectDisplay').textContent = selectedSubject || "Wszystkie";
        const gradesTableContainer = document.getElementById('teacherGradesTableContainer'); const teacherGrades = grades.filter(g => g.teacherId === loggedInUser.id && g.subject === selectedSubject);
        let tableHtml = `<table><thead><tr><th>ID Oceny</th><th>Uczeń</th><th>Ocena</th><th>Opis</th><th>Data</th><th>Akcje</th></tr></thead><tbody>`;
        teacherGrades.forEach(grade => { const student = users.find(u => u.id === grade.studentId); tableHtml += `<tr><td>${grade.id}</td><td>${student ? student.name : 'Nieznany'}</td><td>${grade.value}</td><td>${grade.description || '-'}</td><td>${grade.date}</td><td><button class="action-btn btn-delete" onclick="deleteGradeByTeacher(${grade.id})">Usuń</button></td></tr>`; });
        tableHtml += `</tbody></table>`; if (teacherGrades.length === 0) tableHtml = "<p>Brak ocen dla wybranego przedmiotu.</p>";
        gradesTableContainer.innerHTML = tableHtml;
    }
    function addGradeByTeacher() { /* ... bez zmian ... */  
        const studentId = parseInt(document.getElementById('teacherStudentSelectGrade').value); const subject = document.getElementById('teacherSubjectSelectGrade').value; const value = document.getElementById('teacherGradeValueInput').value.trim(); const description = document.getElementById('teacherGradeDescriptionInput').value.trim();
        if (!studentId || !subject || !value) { alert("Wybierz ucznia, przedmiot i wprowadź ocenę!"); return; }
        const validGradePattern = /^[1-6][+-]?$|^[PNMpnmp][+-]?$/i;  if (!validGradePattern.test(value) && value.length > 3) { alert("Nieprawidłowy format oceny."); return; }
        const newGrade = { id: getNextId(grades), studentId, subject, value, description, date: new Date().toISOString().split('T')[0], teacherId: loggedInUser.id };
        grades.push(newGrade); saveData(); renderTeacherGradeManagementTable(); alert("Ocena dodana!");
        document.getElementById('teacherGradeValueInput').value = ''; document.getElementById('teacherGradeDescriptionInput').value = '';
    }
    function deleteGradeByTeacher(gradeId) { /* ... bez zmian ... */  
        if (confirm(`Czy na pewno chcesz usunąć ocenę o ID: ${gradeId}?`)) { grades = grades.filter(grade => !(grade.id === gradeId && grade.teacherId === loggedInUser.id)); saveData(); renderTeacherGradeManagementTable(); alert("Ocena usunięta."); }
    }
    function renderTeacherStudentsView() { /* ... bez zmian ... */  
        const container = document.getElementById('teacherStudentsListContainer'); if (!loggedInUser || loggedInUser.role !== 'teacher') { container.innerHTML = "<p>Brak dostępu.</p>"; return; }
        let html = '<h3>Lista uczniów w Twoich klasach:</h3>'; let studentsFound = false;
        if (loggedInUser.classIds && loggedInUser.classIds.length > 0) {
            loggedInUser.classIds.forEach(classId => {
                const currentClass = classes.find(c => c.id === classId); const studentsInClass = users.filter(u => u.role === 'student' && u.classId === classId);
                if (currentClass && studentsInClass.length > 0) { studentsFound = true; html += `<h4>Klasa: ${currentClass.name}</h4><ul>`; studentsInClass.forEach(student => { html += `<li>${student.name} (ID: ${student.id}, Numerek: ${student.specialNumber || 'brak'})</li>`; }); html += '</ul>'; } 
                else if (currentClass) { html += `<h4>Klasa: ${currentClass.name}</h4><p>Brak uczniów w tej klasie.</p>`;}
            });
        }
        if (!studentsFound) html += "<p>Nie jesteś przypisany do żadnych klas lub w Twoich klasach nie ma uczniów.</p>";
        container.innerHTML = html;
    }

    const daysMap = { 1: "Poniedziałek", 2: "Wtorek", 3: "Środa", 4: "Czwartek", 5: "Piątek" };
    const periodsOrder = ["1 (8:00-8:45)", "2 (8:55-9:40)", "3 (9:50-10:35)", "4 (10:55-11:40)", "5 (11:50-12:35)", "6 (12:45-13:30)", "7 (13:40-14:25)", "8 (14:35-15:20)"];
    function renderTimetable() { /* ... bez zmian ... */ 
        const container = document.getElementById('timetableContainer'); const displayOptions = document.getElementById('timetableDisplayOptions'); const classSelect = document.getElementById('timetableClassSelect'); let classIdToDisplay;
        if (loggedInUser.role === 'student') { classIdToDisplay = loggedInUser.classId; displayOptions.style.display = 'none'; } 
        else if (loggedInUser.role === 'teacher' || loggedInUser.role === 'admin') {
            displayOptions.style.display = 'block'; classSelect.innerHTML = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            if (classes.length > 0 && !classSelect.value) { classSelect.value = loggedInUser.classIds ? loggedInUser.classIds[0] : classes[0].id; }
            classIdToDisplay = parseInt(classSelect.value);
        }
        if (!classIdToDisplay) { container.innerHTML = "<p>Nie przypisano klasy lub wybierz klasę.</p>"; return; }
        const classTimetable = timetables.filter(t => t.classId === classIdToDisplay);
        if (classTimetable.length === 0) { container.innerHTML = "<p>Brak planu lekcji dla tej klasy.</p>"; return; }
        const uniquePeriods = [...new Set(classTimetable.map(item => item.period))];
        uniquePeriods.sort((a, b) => { const numA = parseInt(a.split(' ')[0]); const numB = parseInt(b.split(' ')[0]); if (!isNaN(numA) && !isNaN(numB)) return numA - numB; return a.localeCompare(b); });
        let html = '<table><thead><tr><th>Okres</th>'; for (let day = 1; day <= 5; day++) { html += `<th>${daysMap[day]}</th>`; } html += '</tr></thead><tbody>';
        uniquePeriods.forEach(period => {
            html += `<tr><td>${period}</td>`;
            for (let day = 1; day <= 5; day++) {
                const entry = classTimetable.find(e => e.dayOfWeek === day && e.period === period);
                if (entry) { const teacher = users.find(u => u.id === entry.teacherId); html += `<td><strong>${entry.subject}</strong><br><small>${teacher ? teacher.name : 'Brak naucz.'}</small><br><small>Sala: ${entry.room || '-'}</small></td>`; } 
                else { html += '<td>-</td>'; }
            } html += '</tr>';
        }); html += '</tbody></table>'; container.innerHTML = html;
    }

    let currentMessageTab = 'inbox';
    let viewingMessageId = null;
    function updateUnreadMessagesCount() { /* ... bez zmian ... */ 
        const count = messages.filter(m => m.recipientId === loggedInUser.id && !m.read).length;
        document.getElementById('unreadMessagesCount').textContent = count;
    }
    function renderMessages() { /* ... bez zmian ... */ 
        showMessagesTab(currentMessageTab); updateUnreadMessagesCount();
    }
    function showMessagesTab(tabName) { // Poprawiono resetowanie formularza przy przejściu na "Napisz"
        currentMessageTab = tabName;
        document.getElementById('messagesInboxContainer').style.display = 'none';
        document.getElementById('messagesSentContainer').style.display = 'none';
        document.getElementById('messagesComposeContainer').style.display = 'none';
        document.getElementById('messageViewContainer').style.display = 'none'; 
        document.getElementById('inboxTab').classList.remove('active');
        document.getElementById('sentTab').classList.remove('active');
        document.getElementById('composeTab').classList.remove('active');

        if (tabName === 'inbox') { document.getElementById('messagesInboxContainer').style.display = 'block'; document.getElementById('inboxTab').classList.add('active'); renderInbox(); } 
        else if (tabName === 'sent') { document.getElementById('messagesSentContainer').style.display = 'block'; document.getElementById('sentTab').classList.add('active'); renderSentMessages(); } 
        else if (tabName === 'compose') { 
            document.getElementById('messagesComposeContainer').style.display = 'block'; 
            document.getElementById('composeTab').classList.add('active'); 
            renderComposeMessageForm(); // Zawsze resetuj formularz, chyba że jest to odpowiedź
        }
    }
    function renderInbox() { /* ... bez zmian ... */ 
        const container = document.getElementById('messagesInboxContainer');
        const inboxMessages = messages.filter(m => m.recipientId === loggedInUser.id).sort((a,b) => new Date(b.date) - new Date(a.date));
        if (inboxMessages.length === 0) { container.innerHTML = "<p>Brak wiadomości w skrzynce odbiorczej.</p>"; return; }
        let html = inboxMessages.map(msg => { const sender = users.find(u => u.id === msg.senderId); return `<div class="message-item ${msg.read ? '' : 'unread'}" onclick="viewMessage(${msg.id})"><p><strong>Od:</strong> ${sender ? sender.name : 'Nieznany'} | <strong>Tytuł:</strong> ${msg.title}</p><p><small>${new Date(msg.date).toLocaleString()}</small></p></div>`; }).join('');
        container.innerHTML = html;
    }
    function renderSentMessages() { /* ... bez zmian ... */ 
        const container = document.getElementById('messagesSentContainer');
        const sentMessages = messages.filter(m => m.senderId === loggedInUser.id).sort((a,b) => new Date(b.date) - new Date(a.date));
        if (sentMessages.length === 0) { container.innerHTML = "<p>Brak wysłanych wiadomości.</p>"; return; }
        let html = sentMessages.map(msg => { const recipient = users.find(u => u.id === msg.recipientId); return `<div class="message-item" onclick="viewMessage(${msg.id})"><p><strong>Do:</strong> ${recipient ? recipient.name : 'Nieznany'} | <strong>Tytuł:</strong> ${msg.title}</p><p><small>${new Date(msg.date).toLocaleString()}</small></p></div>`; }).join('');
        container.innerHTML = html;
    }
    function renderComposeMessageForm(replyToMsg = null) { // Poprawiono, aby recipientSelect był zawsze wypełniany
        const recipientSelect = document.getElementById('messageRecipient');
        const titleInput = document.getElementById('messageTitle');
        const contentInput = document.getElementById('messageContent');

        // Zawsze wypełniaj listę odbiorców
        recipientSelect.innerHTML = users
            .filter(u => u.id !== loggedInUser.id) 
            .map(u => `<option value="${u.id}">${u.name} (${u.role === 'student' ? 'Uczeń' : u.role === 'teacher' ? 'Nauczyciel' : 'Admin'})</option>`)
            .join('');
        
        if (replyToMsg) {
            recipientSelect.value = replyToMsg.senderId; // Ustaw odbiorcę na nadawcę oryginalnej wiadomości
            titleInput.value = `Re: ${replyToMsg.title}`;
            contentInput.value = `\n\n----- Wiadomość oryginalna -----\nOd: ${users.find(u=>u.id === replyToMsg.senderId)?.name}\nData: ${new Date(replyToMsg.date).toLocaleString()}\nTreść:\n${replyToMsg.content}`;
            contentInput.focus();
        } else { // Nowa wiadomość lub przejście na zakładkę "Napisz"
            titleInput.value = '';
            contentInput.value = '';
            if (users.filter(u => u.id !== loggedInUser.id).length > 0) { // Ustaw domyślnego odbiorcę, jeśli lista nie jest pusta
                 recipientSelect.selectedIndex = 0; // Wybierz pierwszego użytkownika z listy jako domyślnego
            }
        }
    }
    function sendMessage() { // Poprawki w logice wysyłania
        console.log("Attempting to send message...");
        const recipientId = parseInt(document.getElementById('messageRecipient').value);
        const title = document.getElementById('messageTitle').value.trim();
        const content = document.getElementById('messageContent').value.trim();

        console.log("Recipient ID:", recipientId, "Title:", title, "Content length:", content.length, "Sender ID:", loggedInUser.id);

        if (!recipientId || isNaN(recipientId)) { alert("Wybierz prawidłowego odbiorcę!"); return; }
        if (!title || !content) { alert("Tytuł i treść wiadomości są wymagane!"); return; }

        const newMessage = {
            id: getNextId(messages),
            senderId: loggedInUser.id,
            recipientId: recipientId,
            title: title,
            content: content,
            date: new Date().toISOString(),
            read: false
        };
        messages.push(newMessage);
        console.log("New message added:", newMessage);
        saveData();
        alert("Wiadomość wysłana!");
        // Nie czyść formularza tutaj, renderComposeMessageForm zrobi to przy przejściu na zakładkę
        showMessagesTab('sent'); // Przejdź do wysłanych
        updateUnreadMessagesCount(); // Zaktualizuj licznik dla innych użytkowników (symulacja)
    }
    function viewMessage(messageId) { /* ... bez zmian ... */ 
        viewingMessageId = messageId; const msg = messages.find(m => m.id === messageId); if (!msg) return;
        if (msg.recipientId === loggedInUser.id && !msg.read) { msg.read = true; saveData(); updateUnreadMessagesCount(); if (currentMessageTab === 'inbox') renderInbox(); }
        document.getElementById('messagesInboxContainer').style.display = 'none'; document.getElementById('messagesSentContainer').style.display = 'none'; document.getElementById('messagesComposeContainer').style.display = 'none'; document.getElementById('messageViewContainer').style.display = 'block';
        const sender = users.find(u => u.id === msg.senderId); const recipient = users.find(u => u.id === msg.recipientId);
        document.getElementById('viewMessageTitle').textContent = msg.title; document.getElementById('viewMessageSender').textContent = sender ? sender.name : 'Nieznany'; document.getElementById('viewMessageRecipient').textContent = recipient ? recipient.name : 'Nieznany'; document.getElementById('viewMessageDate').textContent = new Date(msg.date).toLocaleString(); document.getElementById('viewMessageContent').innerHTML = msg.content.replace(/\n/g, '<br>');
        document.getElementById('replyMessageBtn').style.display = (msg.recipientId === loggedInUser.id) ? 'inline-block' : 'none';
    }
    function hideMessageView() { /* ... bez zmian ... */ 
        document.getElementById('messageViewContainer').style.display = 'none'; viewingMessageId = null; showMessagesTab(currentMessageTab); 
    }
    function replyToMessage() { /* ... bez zmian ... */ 
        if (!viewingMessageId) return; const originalMessage = messages.find(m => m.id === viewingMessageId); if (!originalMessage) return;
        showMessagesTab('compose'); renderComposeMessageForm(originalMessage); 
    }

    function toggleAddAnnouncementForm() { /* ... bez zmian ... */  
        const form = document.getElementById('addAnnouncementFormContainer'); form.style.display = form.style.display === 'none' ? 'block' : 'none'; 
    }
    function renderAnnouncements() { /* ... bez zmian ... */  
        const container = document.getElementById('announcementsListContainer'); const audienceSelect = document.getElementById('announcementAudience'); 
        audienceSelect.innerHTML = `<option value="all">Wszyscy</option><option value="all_students">Wszyscy Uczniowie</option><option value="all_teachers">Wszyscy Nauczyciele</option>${classes.map(c => `<option value="class_${c.id}">Klasa ${c.name}</option>`).join('')}`;
        const userAnnouncements = announcements.filter(ann => {
            if (ann.audience === 'all') return true; if (loggedInUser.role === 'student' && ann.audience === 'all_students') return true; if (loggedInUser.role === 'teacher' && ann.audience === 'all_teachers') return true; if (loggedInUser.role === 'student' && ann.audience === `class_${loggedInUser.classId}`) return true;
            if (loggedInUser.role === 'teacher' && loggedInUser.classIds && loggedInUser.classIds.some(clsId => ann.audience === `class_${clsId}`)) return true; if (loggedInUser.role === 'admin') return true; return false;
        }).sort((a,b) => new Date(b.date) - new Date(a.date));
        if (userAnnouncements.length === 0) { container.innerHTML = "<p>Brak aktualnych ogłoszeń.</p>"; return; }
        let html = userAnnouncements.map(ann => {
            const author = users.find(u => u.id === ann.authorId) || {name: ann.authorName || 'System'}; let audienceDisplay = ann.audience;
            if(ann.audience.startsWith('class_')) { const classId = parseInt(ann.audience.split('_')[1]); const className = classes.find(c => c.id === classId)?.name; audienceDisplay = className ? `Klasa ${className}` : 'Wybrana klasa'; } 
            else if (ann.audience === 'all_students') audienceDisplay = 'Wszyscy uczniowie'; else if (ann.audience === 'all_teachers') audienceDisplay = 'Wszyscy nauczyciele'; else if (ann.audience === 'all') audienceDisplay = 'Wszyscy';
            return `<div class="panel"><h3>${ann.title}</h3><p><small>Autor: ${author.name} | Data: ${new Date(ann.date).toLocaleDateString()} | Dla: ${audienceDisplay}</small></p><p>${ann.content.replace(/\n/g, '<br>')}</p>${(loggedInUser.role === 'admin' || loggedInUser.id === ann.authorId) ? `<button class="action-btn btn-delete" onclick="deleteAnnouncement(${ann.id})">Usuń</button>` : ''}</div>`;
        }).join(''); container.innerHTML = html;
        document.getElementById('toggleAddAnnouncementBtn').style.display = (loggedInUser.role === 'admin' || loggedInUser.role === 'teacher') ? 'inline-block' : 'none';
        document.getElementById('addAnnouncementFormContainer').style.display = 'none'; 
    }
    function addAnnouncement() { /* ... bez zmian ... */  
        const title = document.getElementById('announcementTitle').value.trim(); const content = document.getElementById('announcementContent').value.trim(); const audience = document.getElementById('announcementAudience').value;
        if (!title || !content) { alert("Tytuł i treść ogłoszenia są wymagane!"); return; }
        const newAnnouncement = { id: getNextId(announcements), title, content, date: new Date().toISOString().split('T')[0], authorId: loggedInUser.id, authorName: loggedInUser.name, audience };
        announcements.push(newAnnouncement); saveData(); renderAnnouncements(); 
        document.getElementById('announcementTitle').value = ''; document.getElementById('announcementContent').value = ''; document.getElementById('addAnnouncementFormContainer').style.display = 'none'; 
    }
    function deleteAnnouncement(announcementId) { /* ... bez zmian ... */  
        const ann = announcements.find(a => a.id === announcementId); if (!ann) return;
        if (loggedInUser.role === 'admin' || loggedInUser.id === ann.authorId) { if (confirm("Czy na pewno chcesz usunąć to ogłoszenie?")) { announcements = announcements.filter(a => a.id !== announcementId); saveData(); renderAnnouncements(); } } 
        else { alert("Nie masz uprawnień do usunięcia tego ogłoszenia."); }
    }

    function toggleAddCalendarEventForm() { /* ... bez zmian ... */ 
         const form = document.getElementById('addCalendarEventFormContainer'); form.style.display = form.style.display === 'none' ? 'block' : 'none'; 
    }
    function renderCalendarEvents() { /* ... bez zmian ... */ 
        const container = document.getElementById('calendarEventsListContainer'); const audienceSelect = document.getElementById('calendarEventAudience'); 
        audienceSelect.innerHTML = `<option value="all">Wszyscy</option><option value="all_students">Wszyscy Uczniowie</option><option value="all_teachers">Wszyscy Nauczyciele</option>${classes.map(c => `<option value="class_${c.id}">Klasa ${c.name}</option>`).join('')}`;
        const userEvents = calendarEvents.filter(event => {
            if (event.audience === 'all') return true; if (loggedInUser.role === 'student' && event.audience === 'all_students') return true; if (loggedInUser.role === 'teacher' && event.audience === 'all_teachers') return true; if (loggedInUser.role === 'student' && event.audience === `class_${loggedInUser.classId}`) return true;
            if (loggedInUser.role === 'teacher' && loggedInUser.classIds && loggedInUser.classIds.some(clsId => event.audience === `class_${clsId}`)) return true; if (loggedInUser.role === 'admin') return true; return false;
        }).sort((a,b) => new Date(a.date) - new Date(b.date)); 
        if (userEvents.length === 0) { container.innerHTML = "<p>Brak nadchodzących wydarzeń w terminarzu.</p>"; return; }
        let html = userEvents.map(event => {
            const creator = users.find(u => u.id === event.createdByUserId); let audienceDisplay = event.audience;
            if(event.audience.startsWith('class_')) { const classId = parseInt(event.audience.split('_')[1]); const className = classes.find(c => c.id === classId)?.name; audienceDisplay = className ? `Klasa ${className}` : 'Wybrana klasa';} 
            else if (event.audience === 'all_students') audienceDisplay = 'Wszyscy uczniowie'; else if (event.audience === 'all_teachers') audienceDisplay = 'Wszyscy nauczyciele'; else if (event.audience === 'all') audienceDisplay = 'Wszyscy';
            return `<div class="panel"><h3>${event.title} (${new Date(event.date).toLocaleDateString()})</h3><p><small>Dodał: ${creator ? creator.name : 'System'} | Dla: ${audienceDisplay}</small></p><p>${event.description.replace(/\n/g, '<br>')}</p>${(loggedInUser.role === 'admin' || loggedInUser.id === event.createdByUserId) ? `<button class="action-btn btn-delete" onclick="deleteCalendarEvent(${event.id})">Usuń</button>` : ''}</div>`;
        }).join(''); container.innerHTML = html;
        document.getElementById('toggleAddCalendarEventBtn').style.display = (loggedInUser.role === 'admin' || loggedInUser.role === 'teacher') ? 'inline-block' : 'none';
        document.getElementById('addCalendarEventFormContainer').style.display = 'none'; 
    }
    function addCalendarEvent() { /* ... bez zmian ... */ 
        const title = document.getElementById('calendarEventTitle').value.trim(); const date = document.getElementById('calendarEventDate').value; const description = document.getElementById('calendarEventDescription').value.trim(); const audience = document.getElementById('calendarEventAudience').value;
        if (!title || !date || !description) { alert("Tytuł, data i opis wydarzenia są wymagane!"); return; }
        const newEvent = { id: getNextId(calendarEvents), title, date, description, audience, createdByUserId: loggedInUser.id };
        calendarEvents.push(newEvent); saveData(); renderCalendarEvents(); 
        document.getElementById('calendarEventTitle').value = ''; document.getElementById('calendarEventDate').value = ''; document.getElementById('calendarEventDescription').value = ''; document.getElementById('addCalendarEventFormContainer').style.display = 'none';
    }
    function deleteCalendarEvent(eventId) { /* ... bez zmian ... */ 
        const event = calendarEvents.find(e => e.id === eventId); if (!event) return;
        if (loggedInUser.role === 'admin' || loggedInUser.id === event.createdByUserId) { if (confirm("Czy na pewno chcesz usunąć to wydarzenie z kalendarza?")) { calendarEvents = calendarEvents.filter(e => e.id !== eventId); saveData(); renderCalendarEvents(); }} 
        else { alert("Nie masz uprawnień do usunięcia tego wydarzenia."); }
    }

    function renderAdminTimetableManagement() { /* ... bez zmian ... */ 
        const classSelect = document.getElementById('adminTimetableClassSelect'); classSelect.innerHTML = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        const teacherSelect = document.getElementById('adminTimetableTeacherSelect'); teacherSelect.innerHTML = '<option value="">(Brak nauczyciela)</option>' + users.filter(u => u.role === 'teacher').map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        if (classes.length > 0) { classSelect.value = classes[0].id; renderAdminTimetableEditor(); } else { document.getElementById('adminTimetablePreviewContainer').innerHTML = "<p>Brak klas do zarządzania planem.</p>" }
        clearAdminTimetableForm();
    }
    function clearAdminTimetableForm() { /* ... bez zmian ... */ 
        document.getElementById('adminTimetableEntryId').value = ''; document.getElementById('adminTimetableDay').value = '1'; document.getElementById('adminTimetablePeriod').value = ''; document.getElementById('adminTimetableSubject').value = ''; document.getElementById('adminTimetableTeacherSelect').value = ''; document.getElementById('adminTimetableRoom').value = '';
    }
    function renderAdminTimetableEditor() { /* ... bez zmian ... */ 
        const classId = parseInt(document.getElementById('adminTimetableClassSelect').value); const container = document.getElementById('adminTimetablePreviewContainer'); if (!classId) { container.innerHTML = "<p>Wybierz klasę.</p>"; return; }
        const classTimetable = timetables.filter(t => t.classId === classId); const uniquePeriods = [...new Set(classTimetable.map(item => item.period))];
        uniquePeriods.sort((a, b) => {  const numA = parseInt(a.split(' ')[0]); const numB = parseInt(b.split(' ')[0]); if (!isNaN(numA) && !isNaN(numB)) return numA - numB; return a.localeCompare(b); });
        let html = '<table><thead><tr><th>Okres</th>'; for (let day = 1; day <= 5; day++) { html += `<th>${daysMap[day]}</th>`; } html += '</tr></thead><tbody>';
        uniquePeriods.forEach(period => {
            html += `<tr><td>${period}</td>`;
            for (let day = 1; day <= 5; day++) {
                const entry = classTimetable.find(e => e.dayOfWeek === day && e.period === period);
                if (entry) { const teacher = users.find(u => u.id === entry.teacherId); html += `<td onclick="loadTimetableEntryForEdit(${entry.id})"><strong>${entry.subject}</strong><br><small>${teacher ? teacher.name : 'Brak naucz.'}</small><br><small>Sala: ${entry.room || '-'}</small><br><button class="action-btn btn-delete btn-small" style="padding:2px 5px; font-size:10px;" onclick="event.stopPropagation(); deleteTimetableEntryByAdmin(${entry.id});">Usuń</button></td>`; } 
                else { html += `<td onclick="prefillTimetableFormForAdd(${classId}, ${day}, '${period}')">-</td>`; }
            } html += '</tr>';
        }); html += '</tbody></table>'; if (uniquePeriods.length === 0) html = "<p>Brak planu dla tej klasy. Dodaj pierwsze pozycje.</p>";
        container.innerHTML = html;
    }
    function prefillTimetableFormForAdd(classId, day, period) { /* ... bez zmian ... */ 
        clearAdminTimetableForm(); document.getElementById('adminTimetableClassSelect').value = classId; document.getElementById('adminTimetableDay').value = day; document.getElementById('adminTimetablePeriod').value = period; document.getElementById('adminTimetableSubject').focus();
    }
    function loadTimetableEntryForEdit(entryId) { /* ... bez zmian ... */ 
        const entry = timetables.find(e => e.id === entryId); if (!entry) return;
        document.getElementById('adminTimetableEntryId').value = entry.id; document.getElementById('adminTimetableClassSelect').value = entry.classId; document.getElementById('adminTimetableDay').value = entry.dayOfWeek; document.getElementById('adminTimetablePeriod').value = entry.period; document.getElementById('adminTimetableSubject').value = entry.subject; document.getElementById('adminTimetableTeacherSelect').value = entry.teacherId || ''; document.getElementById('adminTimetableRoom').value = entry.room || '';
        window.scrollTo(0, document.getElementById('adminTimetableManagementSection').offsetTop); 
    }
    function saveTimetableEntryByAdmin() { /* ... bez zmian ... */ 
        const entryId = document.getElementById('adminTimetableEntryId').value ? parseInt(document.getElementById('adminTimetableEntryId').value) : null; const classId = parseInt(document.getElementById('adminTimetableClassSelect').value); const dayOfWeek = parseInt(document.getElementById('adminTimetableDay').value); const period = document.getElementById('adminTimetablePeriod').value.trim(); const subject = document.getElementById('adminTimetableSubject').value.trim(); const teacherId = document.getElementById('adminTimetableTeacherSelect').value ? parseInt(document.getElementById('adminTimetableTeacherSelect').value) : null; const room = document.getElementById('adminTimetableRoom').value.trim();
        if (!classId || !period || !subject) { alert("Klasa, okres i przedmiot są wymagane!"); return; }
        if (entryId) { const index = timetables.findIndex(e => e.id === entryId); if (index > -1) { timetables[index] = { ...timetables[index], classId, dayOfWeek, period, subject, teacherId, room }; } } 
        else { const conflict = timetables.find(e => e.classId === classId && e.dayOfWeek === dayOfWeek && e.period === period); if(conflict) { alert("W tym czasie i dla tej klasy już istnieje wpis w planie."); return; } const newEntry = { id: getNextId(timetables), classId, dayOfWeek, period, subject, teacherId, room }; timetables.push(newEntry); }
        saveData(); renderAdminTimetableEditor(); clearAdminTimetableForm(); alert("Plan lekcji zaktualizowany!");
    }
    function deleteTimetableEntryByAdmin(entryId) { /* ... bez zmian ... */ 
        if (confirm("Czy na pewno chcesz usunąć ten wpis z planu lekcji?")) { timetables = timetables.filter(e => e.id !== entryId); saveData(); renderAdminTimetableEditor(); }
    }

    // --- NOWE FUNKCJE: USTAWIENIA I FREKWENCJA (STUDENT) ---
    function renderSettings() {
        if (!loggedInUser) return;
        document.getElementById('settingCurrentName').value = loggedInUser.name;
        document.getElementById('settingNewName').value = ''; // Wyczyść poprzednie wpisy
    }

    function updateUserDisplayName() {
        if (!loggedInUser) return;
        const newName = document.getElementById('settingNewName').value.trim();
        if (!newName) {
            alert("Nowa nazwa nie może być pusta."); return;
        }
        if (newName === loggedInUser.name) {
            alert("Nowa nazwa jest taka sama jak obecna."); return;
        }

        loggedInUser.name = newName; // Aktualizuj obiekt zalogowanego użytkownika
        const userInArray = users.find(u => u.id === loggedInUser.id); // Znajdź użytkownika w głównej tablicy
        if (userInArray) {
            userInArray.name = newName; // Zaktualizuj również w głównej tablicy
        }

        saveData(); // Zapisz zmiany

        // Zaktualizuj interfejs użytkownika
        document.getElementById('welcomeText').textContent = `Witaj, ${loggedInUser.name}!`;
        document.getElementById('userAvatar').textContent = loggedInUser.name.charAt(0).toUpperCase();
        document.getElementById('loggedUserName').textContent = loggedInUser.name;
        document.getElementById('settingCurrentName').value = loggedInUser.name; 
        document.getElementById('settingNewName').value = ''; 

        alert("Nazwa wyświetlana została zaktualizowana.");
    }
    
    function renderStudentAttendance() {
        if (!loggedInUser || loggedInUser.role !== 'student') {
             document.getElementById('studentAttendanceListContainer').innerHTML = "<p>Brak dostępu.</p>";
             return;
        }
        const container = document.getElementById('studentAttendanceListContainer');
        const studentAttendanceRecords = attendance
            .filter(a => a.studentId === loggedInUser.id)
            .sort((a, b) => new Date(b.date) - new Date(a.date)); // Najnowsze najpierw

        if (studentAttendanceRecords.length === 0) {
            container.innerHTML = "<p>Brak zarejestrowanej frekwencji.</p>"; return;
        }

        let html = `<table>
                        <thead><tr><th>Data</th><th>Przedmiot/Godzina</th><th>Status</th><th>Nauczyciel</th></tr></thead>
                        <tbody>`;
        studentAttendanceRecords.forEach(record => {
            const teacher = users.find(u => u.id === record.teacherId);
            html += `<tr>
                        <td>${new Date(record.date).toLocaleDateString()}</td>
                        <td>${record.subject || 'N/A'}</td>
                        <td>${record.status}</td>
                        <td>${teacher ? teacher.name : 'N/A'}</td>
                     </tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }
    
    // --- ZARZĄDZANIE FREKWENCJĄ PRZEZ NAUCZYCIELA (Szkic) ---
    function renderTeacherAttendanceManagement() {
        if (!loggedInUser || loggedInUser.role !== 'teacher') return;

        const classSelect = document.getElementById('attTeacherClassSelect');
        const subjectSelect = document.getElementById('attSubjectSelect'); // Dodano
        const dateInput = document.getElementById('attDateSelect');

        // Wypełnij klasy nauczyciela
        classSelect.innerHTML = (loggedInUser.classIds || [])
            .map(clsId => classes.find(c => c.id === clsId))
            .filter(c => c) // Usuń niezdefiniowane (jeśli classId nie istnieje)
            .map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        
        // Wypełnij przedmioty nauczyciela (lub pozycje z planu dla wybranej klasy i dnia)
        // Na razie prosta lista przedmiotów nauczyciela
        subjectSelect.innerHTML = (loggedInUser.subjects || [])
            .map(subj => `<option value="${subj}">${subj}</option>`).join('');


        if (!dateInput.value) { // Ustaw domyślną datę na dzisiaj, jeśli nie ustawiona
            dateInput.value = new Date().toISOString().split('T')[0];
        }

        renderTeacherAttendanceEditor(); // Wyrenderuj edytor dla domyślnych wartości
    }

    function renderTeacherAttendanceEditor() {
        const classId = parseInt(document.getElementById('attTeacherClassSelect').value);
        const date = document.getElementById('attDateSelect').value;
        const subject = document.getElementById('attSubjectSelect').value; // Dodano
        const container = document.getElementById('teacherAttendanceEditorContainer');

        if (!classId || !date || !subject) {
            container.innerHTML = "<p>Wybierz klasę, datę i przedmiot/godzinę, aby zarządzać frekwencją.</p>";
            return;
        }

        const studentsInClass = users.filter(u => u.role === 'student' && u.classId === classId);
        if (studentsInClass.length === 0) {
            container.innerHTML = "<p>Brak uczniów w wybranej klasie.</p>";
            return;
        }
        
        let html = `<h4>Uczniowie w klasie ${classes.find(c=>c.id === classId)?.name || ''} - ${subject} (${date})</h4>`;
        html += '<table><thead><tr><th>Uczeń</th><th>Status Frekwencji</th></tr></thead><tbody>';

        studentsInClass.forEach(student => {
            const currentAtt = attendance.find(a => a.studentId === student.id && a.date === date && a.subject === subject);
            const currentStatus = currentAtt ? currentAtt.status : 'obecny'; // Domyślnie obecny

            html += `<tr>
                        <td>${student.name}</td>
                        <td>
                            <select data-student-id="${student.id}" class="attendance-status-select">
                                <option value="obecny" ${currentStatus === 'obecny' ? 'selected' : ''}>Obecny</option>
                                <option value="spóźniony" ${currentStatus === 'spóźniony' ? 'selected' : ''}>Spóźniony</option>
                                <option value="nieobecny" ${currentStatus === 'nieobecny' ? 'selected' : ''}>Nieobecny</option>
                                <option value="nieobecny (uspraw.)" ${currentStatus === 'nieobecny (uspraw.)' ? 'selected' : ''}>Nieobecny (uspraw.)</option>
                                <option value="zwolniony" ${currentStatus === 'zwolniony' ? 'selected' : ''}>Zwolniony</option>
                            </select>
                        </td>
                     </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function saveTeacherAttendanceChanges() {
        const classId = parseInt(document.getElementById('attTeacherClassSelect').value);
        const date = document.getElementById('attDateSelect').value;
        const subject = document.getElementById('attSubjectSelect').value; // Dodano

        if (!classId || !date || !subject) {
            alert("Proszę wybrać klasę, datę i przedmiot."); return;
        }

        const statusSelects = document.querySelectorAll('.attendance-status-select');
        let changesMade = 0;
        statusSelects.forEach(select => {
            const studentId = parseInt(select.dataset.studentId);
            const newStatus = select.value;

            // Znajdź istniejący wpis lub stwórz nowy
            let attRecord = attendance.find(a => a.studentId === studentId && a.date === date && a.subject === subject);
            if (attRecord) {
                if (attRecord.status !== newStatus) {
                    attRecord.status = newStatus;
                    attRecord.teacherId = loggedInUser.id; // Upewnij się, że nauczyciel jest przypisany
                    changesMade++;
                }
            } else {
                attendance.push({
                    id: getNextId(attendance),
                    studentId: studentId,
                    date: date,
                    subject: subject,
                    status: newStatus,
                    teacherId: loggedInUser.id
                });
                changesMade++;
            }
        });

        if (changesMade > 0) {
            saveData();
            alert("Zmiany w frekwencji zostały zapisane.");
            renderTeacherAttendanceEditor(); // Odśwież widok
        } else {
            alert("Nie wprowadzono żadnych zmian w frekwencji.");
        }
    }


    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        loadData(); 
        checkAuth(); 

        const passwordField = document.getElementById('password');
        if (passwordField) { 
             passwordField.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    if (document.getElementById('loginPage').style.display === 'flex' || document.getElementById('loginPage').style.display === '') {
                         login();
                    }
                }
            });
        }
    });

    </script>
</body>
</html>